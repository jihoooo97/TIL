# 메모리 안전

<br>

## 메모리 접근 충돌의 이해

> 프로그래머가 변수에 값을 할당한다던가 함수의 전달인자로 변수의 값을 전달하는 등 다양한 경우에 코드를 통해 메모리에 접근하게 된다.

```swift
// one이 저장될 메모리 위치에 쓰기 접근
var one: Int = 1

// one이 저장된 메모리 위치에 읽기 접근
print("숫자 출력: \(one)")
```

<br>

> 메모리 접근 충돌은 서로 다른 코드에서 동시에 같은 위치의 메모리에 접근할 때 발생한다. 동시에 여러 접근을 하게 되면 예상치 못한 결과를 얻을 수 있다. 예를 들어, 어떤 인스턴스의 내부의 여러 프로퍼티의 값을 합산하여 반환하는 함수가 있을 때, 외부의 한 코드에서 인스턴스의 프로퍼티 값 일부를 수정하고, 동시에 또 다른 어딘가의 코드에서 합산하여 결과를 돌려주는 함수를 호출한다면 그 결과를 예측할 수 있을까? 동시에 일어나는 일이라면 수정 전의 합산 결과를 돌려줄지, 수정된 값의 합산 결과를 돌려줄지 누구도 장담할 수 없다. 이런 일이 발생하지 않을 것이라고 생각하겠지만, 다중 스레드 프로그램에서는 흔히 겪을 수 있는 일이다.

<br>


### 메모리 접근의 특성

> 메모리 접근 충돌을 일으키는 메모리 접근에는 세 가지 특성이 있다. 다음의 세 가지 조건에 모두 해당하는 메모리 접근이 두 군데 이상의 코드에서 동시에 일어나면 메모리 접근 충돌이 발생한다.
> - 최소한 한 곳에서 쓰기 접근한다
> - 같은 메모리 위치에 접근한다
> - 접근 타이밍이 겹친다
>
> 순차적으로 코드를 실행하고, 메모리에 접근하는 것이 순간적이라면 다른 코드에서 같은 메모리 위치에 동시에 접근할 일이 없다. 단일 스레드 환경에서는 대부분의 메모리 접근이 순간적 접근이고 동시에 다른 코드에서 접근할 일이 없다.

```swift
func oneMore(than number: Int) -> Int {
    return number + 1
}

var myNumber: Int = 1
myNumber = oneMore(than: myNumber)
print(myNumber) // 2
```

<br>

> 반면에 장기적 메모리 접근이라는 접근 방식도 있다. 장기적 메모리접근 중에는 해당 메모리 접근이 끝나기 전에 다른 코드에서 메모리에 접근할 가능성이 있다. 접근 타이밍이 겹치게 되는 것이다.

> 접근 타이밍이 겹치게되는 대표적 상황은 함수나 메서드에서 inout을 사용한 입출력 매개변수를 사용하는 경우나 구조체에서 mutating 키워드를 사용하는 가변 메서드를 사용하는 경우이다. 메모리의 같은 위치에 접근하는 여러 접근의 타이밍이 겹친다고해서 무조건적으로 메모리 접근 충돌이 발생하는 것은 아니다. 그렇지만 접근 타이밍이 겹치는 경우 대개 메모리 접근 충돌이 발생할 가능성이 크다. 메모리 접근 충돌을 코드에서 정적으로 예측할 수 있는 경우 컴파일러에서 오류로 취급하여 컴파일하지 않는다.

<br><br>

